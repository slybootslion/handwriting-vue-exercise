{"version":3,"file":"bundle.js","sources":["../src/shared/index.ts","../src/reactivity/effect.ts","../src/reactivity/baseHandle.ts","../src/reactivity/reacive.ts","../src/reactivity/computed.ts","../src/reactivity/ref.ts"],"sourcesContent":["const isObject = (obj: unknown): boolean => typeof obj === 'object' && obj != null\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty\r\nconst hasOwn = (target, key): boolean => hasOwnProperty.call(target, key)\r\n\r\nconst isArray = (obj): boolean => Array.isArray(obj)\r\n\r\nconst isFunction = (fn): boolean => typeof fn === 'function'\r\n\r\nconst hasChange = (oldVal, newVal): boolean => oldVal !== newVal\r\n\r\nexport {\r\n  isObject,\r\n  hasOwn,\r\n  isArray,\r\n  isFunction,\r\n  hasChange\r\n}\r\n","import { isArray } from \"../shared/index\"\r\n\r\n// 依赖收集\r\nconst effect = (fn: Function, options: any = {}) => {\r\n  const effect = createReactiveEffect(fn, options)\r\n  if (!options.lazy) {\r\n    effect()\r\n  }\r\n  return effect\r\n}\r\n\r\nconst effectStack: Function[] = []\r\nlet activeEffect: null | Function = null\r\nfunction createReactiveEffect(fn: Function, options) {\r\n  // reactiveEffect只是提示看源码的人的（没有实际用处）\r\n  const effect = function reactiveEffect() {\r\n    if (!effectStack.includes(effect)) {\r\n      try {\r\n        effectStack.push(effect)\r\n        activeEffect = effect\r\n        return fn()\r\n      } finally {\r\n        effectStack.pop()\r\n        activeEffect = effectStack[effectStack.length - 1]\r\n      }\r\n    }\r\n  }\r\n  effect.options = options\r\n  return effect\r\n}\r\n\r\nconst targetMap = new WeakMap()\r\nfunction track(target, key) {\r\n  if (activeEffect == null) return\r\n\r\n  let depsMap = targetMap.get(target)\r\n  if (!depsMap) targetMap.set(target, (depsMap = new Map()))\r\n\r\n  let dep = depsMap.get(key)\r\n  if (!dep) depsMap.set(key, (dep = new Set()))\r\n\r\n  if (!dep.has(activeEffect)) dep.add(activeEffect)\r\n}\r\n\r\nfunction run(effects) {\r\n  if (effects) effects.forEach(effect => {\r\n    if (effect.options.scheduler) {\r\n      effect.options.scheduler(effect)\r\n      return\r\n    }\r\n    effect()\r\n  })\r\n}\r\n\r\nfunction trigger(target, type, key, value?) {\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) return\r\n\r\n  if (key === 'length' && isArray(target)) {\r\n    depsMap.forEach((dep, key) => {\r\n      // 如果改变数组长度，触发更新，如果更改的数组长度小于取值长度，触发更新\r\n      if (key === 'length' || key >= value) {\r\n        run(dep)\r\n      }\r\n    })\r\n    return\r\n  }\r\n\r\n  if (key != null) {\r\n    const effects = depsMap.get(key)\r\n    run(effects)\r\n  }\r\n\r\n  switch (type) {\r\n    case 'add':\r\n      if (isArray(target)) {\r\n        if (parseInt(key) === key) {\r\n          run(depsMap.get('length'))\r\n        }\r\n      }\r\n      break\r\n    case 'set':\r\n      break\r\n    default:\r\n      break\r\n  }\r\n}\r\n\r\nexport {\r\n  effect,\r\n  effectStack,\r\n  activeEffect,\r\n  track,\r\n  trigger\r\n}\r\n","import { hasChange, hasOwn, isArray, isObject } from \"../shared\"\r\nimport { activeEffect, effectStack, track, trigger } from \"./effect\"\r\nimport { reactive } from \"./reacive\"\r\n\r\nconst mutableHandlers = {\r\n  // 取值时将effect存储 recevier是代理后的对象\r\n  get(target, key, recevier) {\r\n    const res = Reflect.get(target, key, recevier)\r\n\r\n    // 如果是内置Symbol，排除依赖收集\r\n    if (typeof key === 'symbol') return res\r\n\r\n    track(target, key)\r\n\r\n    // if (res.__v_isRef) return res.value\r\n\r\n    // 取值时，是对象再代理\r\n    return isObject(res) ? reactive(res) : res\r\n  },\r\n  // 更新值的时候将effect更新\r\n  set(target, key, value, recevier) {\r\n    const oldVal = target[key]\r\n\r\n    // 是否是原有的属性（数组根据索引长度判断）\r\n    const hadKey = isArray(target) && (parseInt(key, 10) + '' === key) ?\r\n      Number(key) < target.length :\r\n      hasOwn(target, key)\r\n\r\n    const result = Reflect.set(target, key, value, recevier)\r\n\r\n    if (!hadKey) {\r\n      // 没有该属性，触发新增操作\r\n      trigger(target, 'add', key, value)\r\n    } else if (hasChange(oldVal, value)) {\r\n      //  值改变，修改属性\r\n      trigger(target, 'set', key, value)\r\n    } else {\r\n\r\n\r\n    }\r\n\r\n    effectStack.forEach(effect => effect())\r\n    return result\r\n  }\r\n}\r\n\r\nexport {\r\n  mutableHandlers\r\n}\r\n","import { isObject } from '../shared/index'\r\n\r\nimport { mutableHandlers } from './baseHandle'\r\n\r\nconst reactive = (target: object) => {\r\n  return createReactiveObject(target, mutableHandlers)\r\n}\r\n\r\n// 映射表中的key必须是对象\r\nconst reactiveMap = new WeakMap()\r\n\r\nfunction createReactiveObject(target, baseHandle) {\r\n  if (!isObject(target)) return target\r\n\r\n  // 如果已经代理过了，不需要再次代理\r\n  const existProxy = reactiveMap.get(target)\r\n  if (existProxy) return existProxy\r\n  // 代理 放到映射表中 返回代理\r\n  const proxy = new Proxy(target, baseHandle)\r\n  reactiveMap.set(target, proxy)\r\n  return proxy\r\n}\r\n\r\nexport {\r\n  reactive\r\n}\r\n","import { isFunction } from '../shared/index'\r\nimport { effect, track, trigger } from './effect';\r\n\r\nclass ComputedRefImpl {\r\n  public effect\r\n  public __v_isReadonly = true\r\n  public __V_isRef = true\r\n  public _dirty = true\r\n  public _value\r\n\r\n  constructor(getter, public setter) {\r\n    // 默认getter执行的时候，依赖一个内置的effect\r\n    this.effect = effect(getter, {\r\n      lazy: true,\r\n      scheduler: (effect) => {\r\n        this._dirty = true // 依赖数据变化，需要重新缓存\r\n        trigger(this, 'set', 'value')\r\n      }\r\n    })\r\n  }\r\n\r\n  // 类属性描述器\r\n  get value() {\r\n    if (this._dirty) { // 缓存\r\n      this._value = this.effect()\r\n      track(this, 'value')\r\n      this._dirty = false\r\n    }\r\n    return this._value\r\n  }\r\n\r\n  set value(nVal) {\r\n    this.setter(nVal)\r\n  }\r\n}\r\n\r\nfunction computed(getterOrOptions) {\r\n  let getter;\r\n  let setter;\r\n\r\n  if (isFunction(getterOrOptions)) {\r\n    getter = getterOrOptions\r\n    setter = () => { console.log('computed not set value') }\r\n  } else {\r\n    getter = getterOrOptions.get\r\n    setter = getterOrOptions.set\r\n  }\r\n\r\n  return new ComputedRefImpl(getter, setter)\r\n}\r\n\r\nexport {\r\n  computed\r\n}\r\n","import { hasChange, isObject } from \"../shared\";\r\nimport { track, trigger } from \"./effect\";\r\nimport { reactive } from \"./reacive\";\r\n\r\nclass RefImpl {\r\n  public readonly __v_isRef = true\r\n  public _value;\r\n  constructor(public rawVal) {\r\n    this._value = convert(rawVal)\r\n  }\r\n\r\n  get value() {\r\n    track(this, 'value')\r\n    return this._value\r\n  }\r\n\r\n  set value(nVal) {\r\n    if (hasChange(this.rawVal, nVal)) {\r\n      this.rawVal = nVal\r\n      this._value = convert(nVal)\r\n      trigger(this, 'set', 'value')\r\n    }\r\n  }\r\n}\r\n\r\nfunction ref(rawVal) {\r\n  return new RefImpl(rawVal)\r\n}\r\n\r\nfunction convert(val) {\r\n  return isObject(val) ? reactive(val) : val\r\n}\r\n\r\nclass ObjectRefImpl {\r\n  constructor(public object, public key) { }\r\n\r\n  get value() {\r\n    return this.object[this.key]\r\n  }\r\n\r\n  set value(nVal) {\r\n    this.object[this.key] = nVal\r\n  }\r\n}\r\n\r\nfunction toRefs(object) {\r\n  const result = Array.isArray(object) ? new Array(object.length) : {}\r\n  for (const key in object) {\r\n    result[key] = new ObjectRefImpl(object, key)\r\n  }\r\n  return result\r\n}\r\n\r\nexport {\r\n  ref,\r\n  toRefs\r\n}\r\n"],"names":[],"mappings":"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"}